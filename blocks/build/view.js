import*as e from"@wordpress/interactivity";var t={d:(e,s)=>{for(var o in s)t.o(s,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:s[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const s=(o={getContext:()=>e.getContext,getElement:()=>e.getElement,store:()=>e.store},a={},t.d(a,o),a);var o,a;async function r(e,t){try{const s=e.map((async e=>{const s=await fetch(`https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${e}&${t}&key=AIzaSyBEQiaTL4wMnMCQA2WABjuIAOXLaL5LUo0`).then((e=>e.json()));let o={url:e};return s?.lighthouseResult?.categories?.performance?.score&&(o={...o,performance:Math.round(100*s?.lighthouseResult?.categories?.performance?.score)}),s?.lighthouseResult?.categories?.accessibility?.score&&(o={...o,accessibility:Math.round(100*s?.lighthouseResult?.categories?.accessibility?.score)}),s?.lighthouseResult?.categories?.["best-practices"]?.score&&(o={...o,best_practices:Math.round(100*s?.lighthouseResult?.categories?.["best-practices"]?.score)}),s?.lighthouseResult?.categories?.seo?.score&&(o={...o,seo:Math.round(100*s?.lighthouseResult?.categories?.seo?.score)}),o}));return await Promise.all(s)}catch(e){console.log(e)}}async function c(e,t){try{const s=await fetch(`${e}wp-json/wp/v2/pages${t}`);if(!s.ok)throw new Error("Failed to fetch data");const o=(await s.json()).map((e=>e?.link));return{totalPages:s?.headers.get("x-wp-totalpages"),urls:o}}catch(e){console.error(e)}}async function n(e,t){try{const s=await fetch(`${e}wp-json/wp/v2/posts${t}`);if(!s.ok)throw new Error("Failed to fetch data");const o=(await s.json()).map((e=>e?.link));return{totalPages:s?.headers.get("x-wp-totalpages"),urls:o}}catch(e){console.error(e)}}async function l(e,t){try{const s=await fetch(`${e}wp-json/wp/v2/cpts${t}`);if(!s.ok)throw new Error("Failed to fetch data");const o=(await s.json()).map((e=>e?.link));return console.log(s?.headers,s?.headers.get("x-wp-totalpages")),{totalPages:s?.headers.get("x-wp-totalpages"),urls:o}}catch(e){console.error(e)}}const{state:i,actions:g,callbacks:p}=(0,s.store)("pagespeed-app",{state:{performanceSorted:!1,accessibilitySorted:!1,bestPracticesSorted:!1,seoSorted:!1,get isNotEmpty(){return(0,s.getContext)().pagespeedResults.length>0},get isPerformanceSelected(){return(0,s.getContext)().category.includes("performance")},get isAccessibility(){return(0,s.getContext)().category.includes("accessibility")},get isBestPracticesSelected(){return(0,s.getContext)().category.includes("best-practices")},get isSeoSelected(){return(0,s.getContext)().category.includes("seo")},get progressPercentage(){const e=(0,s.getContext)(),t=Math.round(e.page/e.totalPages*100);return`${t<5?"5":t}%`},get getStatus(){const e=(0,s.getContext)();return`${e.page} out of ${e.totalPages}`}},actions:{submit:async()=>{const e=(0,s.getContext)();if(e.pagespeedResults=[],console.log(e.post_types),p.isUrlValid()){e.bgcolor="#fff",e.processing=!0,e.isDone=!1,e.submitBtnText="Processing...";try{e.post_types.includes("post")&&await g.generateReportPosts(e),e.post_types.includes("page")&&await g.generateReportPages(e),e.post_types.includes("custom_post_type")&&g.generateReportCustomPostTypes(e)}catch(e){console.log(e),alert("Error: Make sure the site is powered by wordpress")}finally{e.processing=!1,e.submitBtnText="Submit",e.bgcolor=""}}else alert("Invalid URL")},generateReportPages:async e=>{let t=!1,s=1;for(;!t;){const o=`?page=${s}`,a=await c(e.url,o);e.status=`Page ${s} out of ${a?.totalPages}`;const n=`strategy=${e.device}&category=${e.category.join("&category=")}`,l=await r(a?.urls,n);e.pagespeedResults=[...e.pagespeedResults,...l],console.log(e.pagespeedResults),s<parseInt(a?.totalPages)?s+=1:(t=!0,e.status="")}},generateReportPosts:async e=>{let t=!1,s=1;for(;!t;){const o=`?page=${s}`,a=await n(e.url,o);e.status=`Page ${s} out of ${a?.totalPages}`;const c=`strategy=${e.device}&category=${e.category.join("&category=")}`,l=await r(a?.urls,c);e.pagespeedResults=[...e.pagespeedResults,...l],console.log(e.pagespeedResults),s<parseInt(a?.totalPages)?s+=1:(t=!0,e.status="")}},generateReportCustomPostTypes:async e=>{let t=!1,s=1;for(;!t;){const o=`?page=${s}`,a=await l(e.url,o);e.status=`Page ${s} out of ${a?.totalPages}`;const c=`strategy=${e.device}&category=${e.category.join("&category=")}`,n=await r(a?.urls,c);e.pagespeedResults=[...e.pagespeedResults,...n],console.log(e.pagespeedResults),s<parseInt(a?.totalPages)?s+=1:(t=!0,e.status="")}}},callbacks:{setUrl:()=>{const e=(0,s.getContext)(),{ref:t}=(0,s.getElement)();e.url=t.value},setOptions:()=>{const e=(0,s.getContext)(),{post_types:t,category:o}=e,{ref:a}=(0,s.getElement)();switch(a.name){case"device":e.device=a.value;break;case"post_types":t.includes(a.value)?e.post_types.splice(t.indexOf(a.value),1):e.post_types.push(a.value);break;case"category":o.includes(a.value)?e.category.splice(o.indexOf(a.value),1):e.category.push(a.value)}},isUrlValid:()=>{try{const e=(0,s.getContext)();return new RegExp("^([a-zA-Z]+:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(e.url)}catch(e){return!1}},getDomainNameFromUrl:()=>{const e=(0,s.getContext)();return new URL(e.url).host},sortPerformance:()=>{const e=(0,s.getContext)();e.pagespeedResults=e.pagespeedResults.sort(((e,t)=>i.performanceSorted?t?.performance-e?.performance:e?.performance-t?.performance)),i.performanceSorted=!i.performanceSorted},sortAccessibility:()=>{const e=(0,s.getContext)();e.pagespeedResults=e.pagespeedResults.sort(((e,t)=>i.accessibilitySorted?t?.accessibility-e?.accessibility:e?.accessibility-t?.accessibility)),i.accessibilitySorted=!i.accessibilitySorted},sortBestPractices:()=>{const e=(0,s.getContext)();e.pagespeedResults=e.pagespeedResults.sort(((e,t)=>i.bestPracticesSorted?t?.best_practices-e?.best_practices:e?.best_practices-t?.best_practices)),i.bestPracticesSorted=!i.bestPracticesSorted},sortSeo:()=>{const e=(0,s.getContext)();e.pagespeedResults=e.pagespeedResults.sort(((e,t)=>i.seoSorted?t?.seo-e?.seo:e?.seo-t?.seo)),i.seoSorted=!i.seoSorted},downloadCSV:()=>{const e=(0,s.getContext)();e.pagespeedResults.length<=0&&alert("Please generate a report first.");const t=Object.keys(e.pagespeedResults[0]),o=[];o.push(t),e.pagespeedResults.forEach((e=>{o.push(Object.values(e))}));let a="";o.forEach((e=>{a+=e.join(",")+"\n"}));const r=new Blob([a],{type:"text/csv;charset=utf-8,"}),c=URL.createObjectURL(r),n=document.createElement("a");n.setAttribute("href",c),n.setAttribute("download",`Pagespeed report for ${p.getDomainNameFromUrl()} - ${(new Date).toLocaleString()}.csv`),n.click()}}});