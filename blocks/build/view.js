import*as t from"@wordpress/interactivity";var e={d:(t,s)=>{for(var a in s)e.o(s,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:s[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const s=(a={getContext:()=>t.getContext,getElement:()=>t.getElement,store:()=>t.store},o={},e.d(o,a),o);var a,o;async function r(t,e){try{const s=t.map((async t=>{const s=await fetch(`https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${t}&${e}&key=AIzaSyBEQiaTL4wMnMCQA2WABjuIAOXLaL5LUo0`).then((t=>t.json()));let a={url:t};return s?.lighthouseResult?.categories?.performance?.score&&(a={...a,performance:Math.round(100*s?.lighthouseResult?.categories?.performance?.score)}),s?.lighthouseResult?.categories?.accessibility?.score&&(a={...a,accessibility:Math.round(100*s?.lighthouseResult?.categories?.accessibility?.score)}),s?.lighthouseResult?.categories?.["best-practices"]?.score&&(a={...a,best_practices:Math.round(100*s?.lighthouseResult?.categories?.["best-practices"]?.score)}),s?.lighthouseResult?.categories?.seo?.score&&(a={...a,seo:Math.round(100*s?.lighthouseResult?.categories?.seo?.score)}),a}));return await Promise.all(s)}catch(t){console.log(t)}}async function c(t,e){try{const s=await fetch(`${t}wp-json/wp/v2/pages${e}`);if(!s.ok)throw new Error("Failed to fetch data");const a=(await s.json()).map((t=>t?.link));return{totalPages:s?.headers.get("x-wp-totalpages"),totalEntries:s?.headers.get("x-wp-total"),urls:a}}catch(t){console.error(t)}}async function n(t,e){try{const s=await fetch(`${t}wp-json/wp/v2/posts${e}`);if(!s.ok)throw new Error("Failed to fetch data");const a=(await s.json()).map((t=>t?.link));return{totalPages:s?.headers.get("x-wp-totalpages"),totalEntries:s?.headers.get("x-wp-total"),urls:a}}catch(t){console.error(t)}}async function p(t,e){try{const s=await fetch(`${t}wp-json/wp/v2/cpts${e}`);if(!s.ok)throw new Error("Failed to fetch data");const a=(await s.json()).map((t=>t?.link));return{totalPages:s?.headers.get("x-wp-totalpages"),totalEntries:s?.headers.get("x-wp-total"),urls:a}}catch(t){console.error(t)}}const{state:i,actions:l,callbacks:g}=(0,s.store)("pagespeed-app",{state:{performanceSorted:!1,accessibilitySorted:!1,bestPracticesSorted:!1,seoSorted:!1,get isNotEmpty(){return(0,s.getContext)().pagespeedResults.length>0},get isReportComplete(){return JSON.stringify((0,s.getContext)().post_types.sort())===JSON.stringify((0,s.getContext)().completed.sort())},get isPageSelected(){return(0,s.getContext)().post_types.includes("page")},get isPostSelected(){return(0,s.getContext)().post_types.includes("post")},get isCptsSelected(){return(0,s.getContext)().post_types.includes("custom_post_type")},get isPerformanceSelected(){return(0,s.getContext)().category.includes("performance")},get isAccessibility(){return(0,s.getContext)().category.includes("accessibility")},get isBestPracticesSelected(){return(0,s.getContext)().category.includes("best-practices")},get isSeoSelected(){return(0,s.getContext)().category.includes("seo")},get getPageProgressPercentage(){const t=(0,s.getContext)(),e=Math.round(t.status.page.page/t.status.page.totalPages*100);return"Error!"==t.status.page.text?"Error!":`${e<5?"5":e}% complete!`},get getPostProgressPercentage(){const t=(0,s.getContext)(),e=Math.round(t.status.post.page/t.status.post.totalPages*100);return"Error!"==t.status.post.text?"Error!":`${e<5?"5":e}% complete!`},get getCptsProgressPercentage(){const t=(0,s.getContext)(),e=Math.round(t.status.cpts.page/t.status.cpts.totalPages*100);return"Error!"==t.status.cpts.text?"Error!":`${e<5?"5":e}% complete!`}},actions:{submit:async()=>{const t=(0,s.getContext)();if(g.resetValues(t),t.post_types.length<=0&&alert("Please select post a post type."),t.category.length<=0&&alert("Please select post a category."),g.isUrlValid()){t.processing=!0,t.submitBtnText="Processing...";try{t.post_types.includes("page")&&await l.generateReportPages(t),t.post_types.includes("post")&&await l.generateReportPosts(t),t.post_types.includes("custom_post_type")&&l.generateReportCustomPostTypes(t)}catch(t){console.log(t),alert("Error: Make sure the site is powered by wordpress")}finally{t.processing=!1,t.submitBtnText="Submit"}}else alert("Invalid URL")},generateReportPages:async t=>{try{t.status.page.processing=!0,t.status.page.isDone=!1;let e=t.status.page.isDone,s=t.status.page.page,a=0;for(;!e;){const o=`?page=${s}`,n=await c(t.url,o);a+=n?.urls.length,t.status.page.text=`Processing ${a} out of ${n?.totalEntries}`,t.status.page.totalPages=n?.totalPages,t.status.page.totalEntries=n?.totalEntries;const p=`strategy=${t.device}&category=${t.category.join("&category=")}`,i=await r(n?.urls,p);t.pagespeedResults=[...t.pagespeedResults,...i],t.totalLinks+=n?.urls.length,s<parseInt(n?.totalPages)?(t.status.page.page+=1,s+=1):(e=!0,t.status.page.isDone=!0,t.status.page.processing=!1,t.status.page.text="Done!")}}catch(e){t.status.page.text="Error!",t.status.page.processing=!1,t.status.page.isDone=!0}finally{t.completed=[...t.completed,"page"]}},generateReportPosts:async t=>{try{t.status.post.processing=!0,t.status.post.isDone=!1;let e=t.status.post.isDone,s=t.status.post.page,a=0;for(;!e;){const o=`?page=${s}`,c=await n(t.url,o);a+=c?.urls.length,t.status.post.text=`${a} out of ${c?.totalEntries}`,t.status.post.totalPages=c?.totalPages,t.status.post.totalEntries=c?.totalEntries;const p=`strategy=${t.device}&category=${t.category.join("&category=")}`,i=await r(c?.urls,p);t.pagespeedResults=[...t.pagespeedResults,...i],t.totalLinks+=c?.urls.length,s<parseInt(c?.totalPages)?(t.status.post.page+=1,s+=1):(e=!0,t.status.post.isDone=!0,t.status.post.processing=!1,t.status.post.text="Done!")}}catch(e){t.status.post.text="Error!",t.status.post.processing=!1,t.status.post.isDone=!0}finally{t.completed=[...t.completed,"post"]}},generateReportCustomPostTypes:async t=>{try{t.status.cpts.processing=!0,t.status.cpts.isDone=!1;let e=t.status.cpts.isDone,s=t.status.cpts.page,a=0;for(;!e;){const o=`?page=${s}`,c=await p(t.url,o);a+=c?.urls.length,t.status.cpts.text=`${a} out of ${c?.totalEntries}`,t.status.cpts.totalPages=c?.totalPages,t.status.cpts.totalEntries=c?.totalEntries;const n=`strategy=${t.device}&category=${t.category.join("&category=")}`,i=await r(c?.urls,n);t.pagespeedResults=[...t.pagespeedResults,...i],t.totalLinks+=c?.urls.length,s<parseInt(c?.totalPages)?(t.status.cpts.page+=1,s+=1):(e=!0,t.status.cpts.isDone=!0,t.status.cpts.processing=!1,t.status.cpts.text="Done!")}}catch(e){t.status.cpts.text="Error!",t.status.cpts.processing=!1,t.status.cpts.isDone=!0}finally{t.completed=[...t.completed,"custom_post_type"]}}},callbacks:{setUrl:()=>{const t=(0,s.getContext)(),{ref:e}=(0,s.getElement)();t.url=e.value},setOptions:()=>{const t=(0,s.getContext)(),{post_types:e,category:a}=t,{ref:o}=(0,s.getElement)();switch(o.name){case"device":t.device=o.value;break;case"post_types":e.includes(o.value)?t.post_types.splice(e.indexOf(o.value),1):t.post_types.push(o.value);break;case"category":a.includes(o.value)?t.category.splice(a.indexOf(o.value),1):t.category.push(o.value)}},isUrlValid:()=>{try{const t=(0,s.getContext)();return new RegExp("^([a-zA-Z]+:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i").test(t.url)}catch(t){return!1}},getDomainNameFromUrl:()=>{const t=(0,s.getContext)();return new URL(t.url).host},sortPerformance:()=>{const t=(0,s.getContext)();t.pagespeedResults=t.pagespeedResults.sort(((t,e)=>i.performanceSorted?e?.performance-t?.performance:t?.performance-e?.performance)),i.performanceSorted=!i.performanceSorted},sortAccessibility:()=>{const t=(0,s.getContext)();t.pagespeedResults=t.pagespeedResults.sort(((t,e)=>i.accessibilitySorted?e?.accessibility-t?.accessibility:t?.accessibility-e?.accessibility)),i.accessibilitySorted=!i.accessibilitySorted},sortBestPractices:()=>{const t=(0,s.getContext)();t.pagespeedResults=t.pagespeedResults.sort(((t,e)=>i.bestPracticesSorted?e?.best_practices-t?.best_practices:t?.best_practices-e?.best_practices)),i.bestPracticesSorted=!i.bestPracticesSorted},sortSeo:()=>{const t=(0,s.getContext)();t.pagespeedResults=t.pagespeedResults.sort(((t,e)=>i.seoSorted?e?.seo-t?.seo:t?.seo-e?.seo)),i.seoSorted=!i.seoSorted},downloadCSV:()=>{const t=(0,s.getContext)();t.pagespeedResults.length<=0&&alert("Please generate a report first.");const e=Object.keys(t.pagespeedResults[0]),a=[];a.push(e),t.pagespeedResults.forEach((t=>{a.push(Object.values(t))}));let o="";a.forEach((t=>{o+=t.join(",")+"\n"}));const r=new Blob([o],{type:"text/csv;charset=utf-8,"}),c=URL.createObjectURL(r),n=document.createElement("a");n.setAttribute("href",c),n.setAttribute("download",`Pagespeed report for ${g.getDomainNameFromUrl()} - ${(new Date).toLocaleString()}.csv`),n.click()},resetValues:t=>{t.pagespeedResults=[],t.completed=[],t.totalLinks=0,t.status={page:{text:"Waiting...",page:1,totalPages:1,totalEntries:0,isDone:!1,processing:!1},post:{text:"Waiting...",page:1,totalPages:1,totalEntries:0,isDone:!1,processing:!1},cpts:{text:"Waiting...",page:1,totalPages:1,totalEntries:0,isDone:!1,processing:!1}}}}});